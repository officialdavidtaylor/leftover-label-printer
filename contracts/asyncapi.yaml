asyncapi: 2.6.0
info:
  title: Leftover Label Printer MQTT Contract
  version: 0.2.0
  description: |
    Contract for backend command dispatch and edge status events.
defaultContentType: application/json
x-versioning-policy:
  scheme: semver
  messageSchemaVersionField: schemaVersion
  compatibility:
    currentMajor: 1
    additiveChanges:
      - optional_fields
      - additive_enum_values
    breakingChangesRequire:
      - major_version_bump
      - migration_guide
      - minimum_deprecation_window_days: 90
  owner: api-team
servers:
  production:
    url: mqtt.example.com:8883
    protocol: mqtt
    description: EMQX broker over TLS
channels:
  printers/{id}/jobs:
    description: Backend command topic for dispatching print jobs to one printer.
    parameters:
      id:
        description: Target printer identifier.
        schema:
          $ref: '#/components/schemas/PrinterId'
    publish:
      operationId: publishPrintJobCommand
      summary: Backend publishes print command to target printer topic
      bindings:
        mqtt:
          qos: 1
          retain: false
      message:
        $ref: '#/components/messages/PrintJobCommand'
  printers/{id}/status:
    description: Agent status topic for job outcomes and heartbeat messages.
    parameters:
      id:
        description: Source printer identifier.
        schema:
          $ref: '#/components/schemas/PrinterId'
    publish:
      operationId: publishPrinterStatus
      summary: Edge agent publishes job outcomes and health
      message:
        oneOf:
          - $ref: '#/components/messages/PrintJobOutcome'
          - $ref: '#/components/messages/PrinterHeartbeat'
components:
  messages:
    PrintJobCommand:
      name: PrintJobCommand
      title: Print Job Command
      payload:
        $ref: '#/components/schemas/PrintJobCommandPayload'
    PrintJobOutcome:
      name: PrintJobOutcome
      title: Print Job Outcome
      payload:
        $ref: '#/components/schemas/PrintJobOutcomePayload'
    PrinterHeartbeat:
      name: PrinterHeartbeat
      title: Printer Heartbeat
      payload:
        $ref: '#/components/schemas/PrinterHeartbeatPayload'
  schemas:
    SchemaVersion:
      type: string
      description: Message payload schema version; semantic versioning with major version 1.
      pattern: '^1\.[0-9]+\.[0-9]+$'
      example: 1.0.0
    PrinterId:
      type: string
      minLength: 1
      description: Stable printer identifier shared between API and MQTT contracts.
      example: printer-1
    PrintJobCommandPayload:
      type: object
      additionalProperties: false
      required:
        - schemaVersion
        - type
        - eventId
        - traceId
        - jobId
        - printerId
        - objectUrl
        - issuedAt
      properties:
        schemaVersion:
          $ref: '#/components/schemas/SchemaVersion'
        type:
          type: string
          enum:
            - print_job_dispatch
        eventId:
          type: string
        traceId:
          type: string
        jobId:
          type: string
        printerId:
          $ref: '#/components/schemas/PrinterId'
        objectUrl:
          type: string
          format: uri
        issuedAt:
          type: string
          format: date-time
    PrintJobOutcomePayload:
      type: object
      additionalProperties: false
      required:
        - schemaVersion
        - type
        - eventId
        - traceId
        - jobId
        - printerId
        - outcome
        - occurredAt
      properties:
        schemaVersion:
          $ref: '#/components/schemas/SchemaVersion'
        type:
          type: string
          enum:
            - job_outcome
        eventId:
          type: string
        traceId:
          type: string
        jobId:
          type: string
        printerId:
          $ref: '#/components/schemas/PrinterId'
        outcome:
          type: string
          enum:
            - printed
            - failed
        occurredAt:
          type: string
          format: date-time
        errorCode:
          type: string
        errorMessage:
          type: string
    PrinterHeartbeatPayload:
      type: object
      additionalProperties: false
      required:
        - schemaVersion
        - eventId
        - traceId
        - printerId
        - type
        - occurredAt
      properties:
        schemaVersion:
          $ref: '#/components/schemas/SchemaVersion'
        eventId:
          type: string
        traceId:
          type: string
        printerId:
          $ref: '#/components/schemas/PrinterId'
        type:
          type: string
          enum:
            - heartbeat
        occurredAt:
          type: string
          format: date-time
        uptimeSeconds:
          type: integer
          minimum: 0
